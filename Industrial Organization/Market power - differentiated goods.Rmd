---
title: 'Industrial Economics: Market power and differentiated goods'
author: "Oriol Eixarch (0872954)  "
date: "23/3/2022"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
local({r <- getOption("repos")
       r["CRAN"] <- 'http://cran.us.r-project.org'
       options(repos=r)})
library(haven)
cars <- read_dta("C:/Users/Oriol/OneDrive/UNI/MASTER/Industrial Organization/Assignment II/cars.dta")
install.packages("expss")
install.packages("dplyr")
install.packages("fastDummies")
install.packages("sjlabelled")
install.packages("ivreg")
library(expss)
library(dplyr)
library(fastDummies)
library(sjlabelled)
library(ivreg)
cars<-unlabel(cars)
cars$Country=NA
cars$Segment=NA
cars$Domestic=NA
"cars$brand1=0
cars$brand2=0
cars$brand3=0
cars$brand4=0
cars$brand5=0
cars$brand6=0
cars$brand7=0
cars$brand8=0
cars$brand9=0
cars$brand10=0
cars$brand11=0
cars$brand12=0
cars$brand13=0
cars$brand14=0
cars$brand15=0
cars$brand16=0
cars$brand17=0
cars$brand18=0
cars$brand19=0
cars$brand20=0
cars$brand21=0
cars$brand22=0
cars$brand23=0
cars$brand24=0
cars$brand25=0
cars$brand26=0
cars$brand27=0
cars$brand28=0
cars$brand29=0
cars$brand30=0
cars$brand31=0
cars$brand32=0
cars$brand33=0
cars$brand34=0
cars$brand35=0
cars$brand36=0
cars$brand37=0
cars$brand38=0
cars$brand39=0
cars$brand40=0
cars$brand41=0
cars$brand42=0
cars$brand43=0
cars$brand44=0
cars$brand45=0
cars$brand46=0
cars$brand47=0
cars$brand48=0
cars$brand1[cars$brand == 1] <- 1
cars$brand2[cars$brand == 2] <- 1
cars$brand3[cars$brand == 3] <- 1
cars$brand4[cars$brand == 4] <- 1
cars$brand5[cars$brand == 5] <- 1
cars$brand6[cars$brand == 6] <- 1
cars$brand7[cars$brand == 7] <- 1
cars$brand8[cars$brand == 8] <- 1
cars$brand9[cars$brand == 9] <- 1
cars$brand10[cars$brand == 10] <- 1
cars$brand11[cars$brand == 11] <- 1
cars$brand12[cars$brand == 12] <- 1
cars$brand13[cars$brand == 13] <- 1
cars$brand14[cars$brand == 14] <- 1
cars$brand15[cars$brand == 15] <- 1
cars$brand16[cars$brand == 16] <- 1
cars$brand17[cars$brand == 17] <- 1
cars$brand18[cars$brand == 18] <- 1
cars$brand19[cars$brand == 19] <- 1
cars$brand20[cars$brand == 20] <- 1
cars$brand21[cars$brand == 21] <- 1
cars$brand22[cars$brand == 22] <- 1
cars$brand23[cars$brand == 23] <- 1
cars$brand24[cars$brand == 24] <- 1
cars$brand25[cars$brand == 25] <- 1
cars$brand26[cars$brand == 26] <- 1
cars$brand27[cars$brand == 27] <- 1
cars$brand28[cars$brand == 28] <- 1
cars$brand29[cars$brand == 29] <- 1
cars$brand30[cars$brand == 30] <- 1
cars$brand31[cars$brand == 31] <- 1
cars$brand32[cars$brand == 32] <- 1
cars$brand33[cars$brand == 33] <- 1
cars$brand34[cars$brand == 34] <- 1
cars$brand35[cars$brand == 35] <- 1
cars$brand36[cars$brand == 36] <- 1
cars$brand37[cars$brand == 37] <- 1
cars$brand38[cars$brand == 38] <- 1
cars$brand39[cars$brand == 39] <- 1
cars$brand40[cars$brand == 40] <- 1
cars$brand41[cars$brand == 41] <- 1
cars$brand42[cars$brand == 42] <- 1
cars$brand43[cars$brand == 43] <- 1
cars$brand44[cars$brand == 44] <- 1
cars$brand45[cars$brand == 45] <- 1
cars$brand46[cars$brand == 46] <- 1
cars$brand47[cars$brand == 47] <- 1
cars$brand48[cars$brand == 48] <- 1"
cars$Domestic[cars$domestic == 0] <- 0
cars$Domestic[cars$domestic == 1] <- 1
cars$Country[cars$country == 1] <- "Belgium"
cars$Country[cars$country == 2] <- "France"
cars$Country[cars$country == 3] <- "Germany"
cars$Country[cars$country == 4] <- "Italy"
cars$Country[cars$country == 5] <- "UK"
cars$Segment[cars$segment == 1] <- "subcompac"
cars$Segment[cars$segment == 2] <- "compact"
cars$Segment[cars$segment == 3] <- "intermedi"
cars$Segment[cars$segment == 4] <- "standard "
cars$Segment[cars$segment == 5] <- "luxury"

```

# I
Description:
```{r}
str(cars[,c("year","country","co","segment","brand","domestic","firm","qu","price","princ","horsepower","fuel","width","height","pop")])
```
Summary:
```{r}
summary(cars[,c("year","country","co","segment","brand","domestic","firm","qu","price","princ","horsepower","fuel","width","height","pop")])
```

# II 
```{r}
cars95=cars[cars$year==1995,]
```
*Country (Percentage, Count):*
```{r}
(cross_tpct(cars95,Country))
(cross_cases(cars95,Country))
```
***
*Domestic (Percentage, Count):*
```{r}
(cross_tpct(cars95,Domestic))
(cross_cases(cars95,Domestic))
```
***
*Segment (Percentage, Count):*
```{r}
(cross_tpct(cars95,Segment))
(cross_cases(cars95,Segment))
```
***
*Cross Tab: Domestic, Country*
```{r}
(cross_cases(cars95,Domestic,Country))

```

# III
We assume that a household is likely to be composed of 3 people, therefore, our household variable will be:
```{r}
cars$household=cars$pop/3
```

# IV
`r colnames(cars[12])` is the more informative variable, since it is relative to income, while, price is more straightforward and easier to understand at a first glance. We believe that the most sensible of the 2 is princ due to the aforementioned relativeness to income, making comparisons between countries easier to understand.

# V
*Logit:*
Base country UK so the constant will be about UK, no base for brand since it would conflict with country. 

$ln(sj/s0) = b_0 + b_1*horsepower + b_2*fuel + b_3*width + b_4*height + b_5*weight + b_6*domestic + b_7*year +$ $b_8*country1 + b_9*country2 + b_{10}*country3 + b_{11}*country4 + b_{12}*brand1 + b_{13}*brand2 + b_{14}*brand3 +$ $b_{15}*brand4 + b_{16}*brand5 + b_{17}*brand6 + b_{18}*brand7 + b_{19}*brand8 + b_{20}*brand9 + b_{21}*brand10 +$  $b_{22}*brand11 + b_{23}*brand12 + b_{24}*brand13 + b_{25}*brand14 + b_{26}*brand15 + b_{27}*brand16 + b_{28}*brand17 +$ $b_{29}*brand18 + b_{30}*brand19 + b_{31}*brand20 + b_{32}*brand21 + b_{33}*brand22 + b_{34}*brand23 + b_{35}*brand24 +$ $b_{36}*brand25 + b_{37}*brand26 + b_{38}*brand27 + b_{39}*brand28 + b_{40}*brand29 + b_{41}*brand30 + b_{42}*brand31 +$ $b_{43}*brand32 + b_{44}*brand33 + b_{45}*brand34 + b_{46}*brand35 + b_{47}*brand36 + b_{48}*brand37 + b_{49}*brand38  -$ $a*princ +ksij$.

***
*Nested logit:*
$ln(sj/s0) = b_0 + b_1*horsepower + b_2*fuel + b_3*width + b_4*height + b_5*weight + b_6*domestic + b_7*year +$ $b_8*country1 + b_9*country2 + b_{10}*country3 + b_{11}*country4 + b_{12}*brand1 + b_{13}*brand2 + b_{14}*brand3 +$ $b_{15}*brand4 + b_{16}*brand5 + b_{17}*brand6 + b_{18}*brand7 + b_{19}*brand8 + b_{20}*brand9 + b_{21}*brand10 +$ $b_{22}*brand11 + b_{23}*brand12 + b_{24}*brand13 + b_{25}*brand14 + b_{26}*brand15 + b_{27}*brand16 + b_{28}*brand17 +$ $b_{29}*brand18 + b_{30}*brand19 + b_{31}*brand20 + b_{32}*brand21 + b_{33}*brand22 + b_{34}*brand23 + b_{35}*brand24 +$ $b_{36}*brand25 + b_{37}*brand26 + b_{38}*brand27 + b_{39}*brand28 + b_{40}*brand29 + b_{41}*brand30 + b_{42}*brand31 +$ $b_{43}*brand32 + b_{44}*brand33 + b_{45}*brand34 + b_{46}*brand35 + b_{47}*brand36 + b_{48}*brand37 + b_{49}*brand38 -$ $a*princ + sigma*ln(sjg) +ksij$.

# VI
```{r}
cars <- cars %>% group_by(country, year) %>% mutate(Q = sum(qu) )
cars$sjs0 = cars$qu/(cars$household - cars$Q)
cars$sj = cars$qu/cars$household
cars <- cars %>% group_by(country, year, segment) %>% mutate(sg = sum(sj))
cars$sjg = cars$sj/cars$sg
cars <- cars %>% group_by(country, year, segment) %>% mutate(sk = sj)""
cars$lnsjs0 = log(cars$sjs0)
cars$lnsjg = log(cars$sjg)
```

# VII
```{r, results='hide'}
cars<-dummy_cols(cars,"brand")
```

*Logit:*
```{r}
(LOLS<-lm(lnsjs0 ~ princ + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47, data=cars))
```
***
*Nested Logit:*
```{r}
(NLOLS<-lm(lnsjs0 ~ princ + lnsjg + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47, data=cars))
```

# VIII
In the following code, all variables that end with 1 or 2 are the required calculations to obtain instruments that are different products of the same firm. Likewise, all variables that end with 3 and 4 are the required calculations to obtain instruments that are the sum of product characteristics of other firms. More specifically, we calculate the sum of all product characteristics and then substract the ones that are from each specific firm to obtain the sum of characteristics of all other firms.

```{r}
cars$cons = 1
cars <- cars %>% group_by(country, year, firm) %>% mutate(cons1 = sum(cons))
cars$cons2 = cars$cons1 - cars$cons
cars <- cars %>% group_by(country, year) %>% mutate(cons3 = sum(cons))
cars$cons4 = cars$cons3 - cars$cons1

cars <- cars %>% group_by(country, year, firm) %>% mutate(horsepower1 = sum(horsepower))
cars$horsepower2 = cars$horsepower1 - cars$horsepower
cars <- cars %>% group_by(country, year) %>% mutate(horsepower3 = sum(horsepower))
cars$horsepower4 = cars$horsepower3 - cars$horsepower1

cars <- cars %>% group_by(country, year, firm) %>% mutate(fuel1 = sum(fuel))
cars$fuel2 = cars$fuel1 - cars$fuel
cars <- cars %>% group_by(country, year) %>% mutate(fuel3 = sum(fuel))
cars$fuel4 = cars$fuel3 - cars$fuel1

cars <- cars %>% group_by(country, year, firm) %>% mutate(width1 = sum(width))
cars$width2 = cars$width1 - cars$width
cars <- cars %>% group_by(country, year) %>% mutate(width3 = sum(width))
cars$width4 = cars$width3 - cars$width1

cars <- cars %>% group_by(country, year, firm) %>% mutate(height1 = sum(height))
cars$height2 = cars$height1 - cars$height
cars <- cars %>% group_by(country, year) %>% mutate(height3 = sum(height))
cars$height4 = cars$height3 - cars$height1

cars <- cars %>% group_by(country, year, firm) %>% mutate(weight1 = sum(weight))
cars$weight2 = cars$weight1 - cars$weight
cars <- cars %>% group_by(country, year) %>% mutate(weight3 = sum(weight))
cars$weight4 = cars$weight3 - cars$weight1

cars <- cars %>% group_by(country, year, firm) %>% mutate(domestic1 = sum(domestic))
cars$domestic2 = cars$domestic1 - cars$domestic
cars <- cars %>% group_by(country, year) %>% mutate(domestic3 = sum(domestic))
cars$domestic4 = cars$domestic3 - cars$domestic1
```

We use BLP instruments because of the potential endogeneity between prices and demand. We may observe high demand with high prices but not take into account the unobserved qualities of the product.The instruments chosen affect price but are not included in the demand equation. Furthermore, we use the constant as a count variable that keeps track of the total number of products that are included in each situation. 

# IX
*Logit:*
```{r}
(IVL<-ivreg(lnsjs0 ~ princ + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47 | cons2 + cons4 + horsepower2 + horsepower4 + fuel2 + fuel4 + width2 + width4 + height2 + height4 + weight2 + weight4 + domestic2 + domestic4 + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47, data=cars))
```

*Nested Logit:*
```{r}
(IVNL<-ivreg(lnsjs0 ~ princ + lnsjg + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47 | cons2 + cons4 + horsepower2 + horsepower4 + fuel2 + fuel4 + width2 + width4 + height2 + height4 + weight2 + weight4 + domestic2 + domestic4 + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47, data=cars))
```

*Comparison of OLS Logit to IV Logit:*

We can clearly see that with OLS, the impact of price on demand was heavily diminished since OLS estimated an effect of `r LOLS$coefficients[2]` on demand while IV estimates `r IVL$coefficients[2]`, more than double of the initial estimation.
This provides a strong indication that there was indeed bias pushing the price estimator towards zero.
As for the rest of the characteristics, their estimated effects on demand gets diminished to varying degrees.

*Comparison of OLS Nested Logit to IV Nested Logit:*

Moving on to the Nested Logit, we see similar results to the regular Logit, to a less dramatic degree.
The price estimator increases in absolute value from `r NLOLS$coefficients[2]` to `r IVNL$coefficients[2]`, while most of the other characteristics stay about the same.
The nesting parameter barely changes with a change from `r NLOLS$coefficients[3]` to `r IVNL$coefficients[3]`.
As a last remark, the trend seems to be completely insignificant in the case of IV Nested Logit and fuel seems to stay insignificant between the 2 regressions.

*Results of IV Nested Logit:*

The signs are as we expected for the most part, price has a negative effect on demand as well as fuel. More horsepower is more desirable as well as buying a domestic car.
A heavier car is less desirable (maybe fuel related). Finally width and height cannot really be predicted signwise beforehand since its personal preference.
As for the nested parameter, a higher marketshare in a specific group of cars correlates with a higher demand for that car.

# X
```{r}
cars$house1 = cars$household/4
cars$sjs01 = cars$qu/(cars$house1 - cars$Q)
cars$sj1 = cars$qu/cars$house1
cars <- cars %>% group_by(country, year, segment) %>% mutate(sg1 = sum(sj1))
cars$sjg1 = cars$sj1/cars$sg1
cars$lnsjs01 = log(cars$sjs01)
cars$lnsjg1 = log(cars$sjg1)

(ivreg(lnsjs0 ~ princ + lnsjg + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47 | cons2 + cons4 + horsepower2 + horsepower4 + fuel2 + fuel4 + width2 + width4 + height2 + height4 + weight2 + weight4 + domestic2 + domestic4 + horsepower + fuel + width + height + weight + domestic + year + country1 + country2 + country3 + country4 + brand_1 + brand_2 + brand_3 + brand_4 + brand_5 + brand_7 + brand_8 + brand_9 + brand_10 + brand_11 + brand_14 + brand_15 + brand_16 + brand_17 + brand_18 + brand_19 + brand_20 + brand_22 + brand_23 + brand_24 + brand_25 + brand_26 + brand_28 + brand_29 + brand_30 + brand_31 + brand_33 + brand_34 + brand_35 + brand_36 + brand_37 + brand_40 + brand_42 + brand_43 + brand_44 + brand_45 + brand_46 + brand_47, data=cars))
```

Trend and fuel appear to be more significant compared to before but for the most part estimates do not change that much. Signs are also the same as before.


# XI

This is the point were we are having trouble wrapping our heads around the results, following the elasticity formulas from the slides with the alpha that we have calculated, we get a positive own price elasticity and a negative cross price elasticity, which is the reverse of what we should be getting. We don't think that the problem lies with our calculations, the sign of the coefficient must be negative for the law of demand to make sense. We will assume that the "$-a$" in the demand equation is the alpha we have calculated, and not just "a". Thus, we remove the -1 from $e_{jj}$ and add it for $e_{jk}$ to fix the signs.

*Logit:*
```{r}
cars$ejj = (IVL$coefficients[2]*(1 - cars$sj)*cars$princ)
cars$ejk = -1*IVL$coefficients[2]*cars$sj*cars$princ
cars$drjk = cars$sk/(1 - cars$sj)
cars$mark = 1/((1 - cars$drjk)*abs(cars$ejj))
cars$mc = -cars$princ*(1 - cars$mark)
summary(cars[,c("ejj","princ","mc","mark")])
```

*Nested Logit:*
```{r}
cars$ejj1 = (IVNL$coefficients[2])*((1/(1-IVNL$coefficients[3])) - (IVNL$coefficients[3]/(1-IVNL$coefficients[3]))*cars$sjg - cars$sj)*cars$princ
cars$ejk1 = -1*IVNL$coefficients[2]*((IVNL$coefficients[3]/(1 - IVNL$coefficients[3]))*cars$sjg + cars$sj)*cars$princ
cars$skg = cars$sk/cars$sg
cars$deltajk = (IVNL$coefficients[3]* cars$skg + (1 - IVNL$coefficients[3])*cars$sk)/(1 - IVNL$coefficients[3]*cars$sjg - (1 - IVNL$coefficients[3])*cars$sj)
cars$mark1 = 1/((1 - cars$deltajk)*abs(cars$ejj1))
cars$mc1 = cars$princ*(1 - cars$mark1)
summary(cars[,c("ejj1","princ","mc1","mark1")])
```

The 2 models vary greatly on both the estimated elasticity as well as the marginal costs and as a result the markups. Nested Logit estimates a way larger own price elasticity and larger marginal costs which in turn lowers the markup significantly.

# XII
*Logit:*
```{r}
cars$mark2 = 1/abs(cars$ejj)
cars$mc2 = cars$princ*(1 - cars$mark2)
summary(cars[,c("mark2","mc2")])
```

*Nested Logit:*
```{r}
cars$mark3 = 1/abs(cars$ejj1)
cars$mc3 = cars$princ*(1 - cars$mark3)
summary(cars[,c("mark3","mc3")])
```

We observe similar results to the ones from question 11. This can be attributed to the low diversion ratio, which suggests that price increases turn customers away from the firm altogether rather than direct them to another of the same firm's product.


# XIII
```{r}
(lm(mc ~ horsepower + fuel + width + height + weight + domestic + country1 + country2 + country3 + country4, data=cars))
```
***
```{r}
(lm(mc1 ~ horsepower + fuel + width + height + weight + domestic + country1 + country2 + country3 + country4, data=cars))
```

Most of the results are as expected, high horsepower and fuel efficiency makes the firms developing the cars incur a bigger cost to produce them. Width, height and weight are difficult to predict ex ante. Height appears to be insignificant in the nested logit. All countries have negative signs and their difference shows us which country is cheaper for car production in general. In that regard, a surprising result is the positive constant in the nested logit. We would expect domestic to have a negative sign since selling cars abroad would increase the costs but logit predicts a positive result.
